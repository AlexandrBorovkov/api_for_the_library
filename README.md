### Тестовое задание ###
## API для Библиотеки ##

## Описание проекта: ##
Вам необходимо разработать RESTful API для базового управления библиотечным каталогом. Система должна позволять управлять информацией о книгах и читателях, а также процессом выдачи и возврата книг, с использованием JWT для аутентификации пользователей (библиотекарей).

## Требования к функционалу: ##
# Аутентификация: #
- Реализовать эндпоинт для регистрации пользователей (библиотекарей) с email и password. Пароль должен храниться в хешированном виде.
- Реализовать эндпоинт для входа пользователей, который по email и password возвращает JWT access token.
- Все последующие операции по управлению книгами, читателями (кроме регистрации/логина самого читателя, если бы он был отдельной сущностью с логином), выдаче и возврату должны быть защищены JWT.
# Управление книгами (Защищено JWT): #
- CRUD операции для книг (Создание, Чтение, Обновление, Удаление).
- Поля книги:
    ID (автоматически генерируемый)
    Название (строка, обязательное)
    Автор (строка, обязательное)
    Год публикации (число, необязательное)
    ISBN (строка, должен быть уникальным, необязательное)
    Количество экземпляров (число, по умолчанию 1, не может быть меньше 0)
# Управление читателями (Защищено JWT, кроме регистрации/логина, если бы они были): #
- CRUD операции для читателей.
- Поля читателя:
    ID (автоматически генерируемый)
    Имя (строка, обязательное)
    Email (строка, должен быть уникальным, обязательное)
- Примечание: В рамках этого задания читатели не имеют собственных паролей и не логинятся в систему. Ими управляют аутентифицированные пользователи (библиотекари).
# Выдача и возврат книг (Защищено JWT): #
- Эндпоинт для выдачи книги читателю:
    Принимает book_id и reader_id.
- Бизнес-логика 1: Книгу можно выдать, только если есть доступные экземпляры (количество экземпляров > 0). При выдаче          количество экземпляров уменьшается на 1.
Фиксируется факт выдачи (например, в отдельной таблице BorrowedBooks с полями id, book_id, reader_id, borrow_date, return_date (изначально NULL)).
- Бизнес-логика 2: Один читатель не может взять более 3-х книг одновременно.
- Эндпоинт для возврата книги читателем:
Принимает book_id и reader_id (или borrow_id если используете отдельную таблицу).
При возврате количество экземпляров соответствующей книги увеличивается на 1.
В записи о выдаче проставляется return_date.
- Бизнес-логика 3: Нельзя вернуть книгу, которая не была выдана этому читателю или уже возвращена.
# Получение информации: #
Эндпоинт для получения списка всех книг (может быть публичным или защищенным JWT – на ваше усмотрение, но объясните свой выбор в README).
Эндпоинт для получения списка всех книг, взятых конкретным читателем (и еще не возвращенных) (Защищено JWT).
# Технические требования: #
- Язык программирования: Python 3.8+
- Фреймворк: FastAPI
- База данных: PostgreSQL (или SQLite для упрощения, но PostgreSQL предпочтительнее)
- ORM: SQLAlchemy (Core или ORM – на выбор кандидата, но ORM предпочтительнее)
- Аутентификация (Новое): JWT (например, с использованием python-jose для токенов и passlib[bcrypt] для хеширования паролей).
- Валидация данных: Pydantic
- Управление миграциями: Alembic (если используется PostgreSQL)
- Тестирование: Pytest. Написать юнит-тесты для проверки бизнес-логики (например, попытка взять 4-ю книгу, попытка взять книгу, которой нет в наличии) и хотя бы один тест для защищенного эндпоинта (проверка доступа с токеном и без).


### Как установить и запустить приложение? ###
1. **Клонирование репозитория**:
    ```sh
    git clone https://github.com/AlexandrBorovkov/api_for_the_library.git
   ```
    или
    ```sh
    git clone git@github.com:AlexandrBorovkov/api_for_the_library.git
    ```
2. **Установка зависимостей**:
    - Установить uv:
    ```sh
    curl -LsSf https://astral.sh/uv/install.sh | sh
    source $HOME/.local/bin/env
    ```
    ```sh
    make install
    ```
3. **Запуск приложения**:
    ```sh
    make start
    ```
---

## Описание принятых решений по структуре БД. ##
На каждую сущность была создана таблица в базе данных.
Для процесса выдачи и возврата книг так же была создана таблица для реализации связи "многое-ко-многим".

## Реализация логики выдачи и возврата книг. ##
При выдаче книги идет проверка:
- Существует ли пользователь.
- Существует ли книга.
- Колличество экземпляров книги должно быть больше чем 0.
- Колличество книг на руках у читателя должно быть не более 3.
- Колличество экземпляров одной книги у читателя не превышает 1.
Если проверка прошла успешно, то создается запись о выдаче книги и колличество экземпляров данной книги сокращается на 1.

При сдаче книги идет поиск в таблице выдачи по id читателя, id книги и условию что дата сдачи is None. Если такая запись найдена, то книга списывается и ее колличество экземпляров увеличивается на 1.

## Реализация аутентификации. ##
Регистрация:
- Проверяется зарегистрирован ли такой email.
- Если такого email нет в базе, то пароль хэштруется и библиотекарь добавляется в таблицу.

Логин:
- Проверка есть ли email в таблице.
- Если email найден, то сравнивается переданный пароль с хэшем из таблицы.
- Если результат аутентификации положительный, то создается JWT токен. В токен записывается id библиотекаря и время истечения.
- Токен сохраняется в cookie и далее браузер автоматически отправляет его при каждом запросе.

## PS ##
Добавил logout и вывод всех записей выдачи книг.
